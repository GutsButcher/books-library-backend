name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [dev, staging]

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: gwynbliedd/book-library

jobs:
  setup-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      release-name: ${{ steps.preview.outputs.release-name }}
      namespace: ${{ steps.preview.outputs.namespace }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      #generate steps are meant to just provide something to >> $GITHUB_OUTPUT in format key=value
    - name: Generate preview namespace
      id: preview
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        NAMESPACE="book-library-pr-${PR_NUMBER}"
        RELEASE_NAME="book-library-pr-${PR_NUMBER}"
        echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT
        echo "release-name=${RELEASE_NAME}" >> $GITHUB_OUTPUT

    - name: Setup Java and Maven
      uses: ./.github/actions/setup-java-maven
      with:
        java-version: '17'

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Set short SHA
      id: short-sha
      run: echo "sha=$(echo ${{ github.sha }} | cut -c1-8 )" >> $GITHUB_OUTPUT
    - name: Build and Push Docker Image
      id: docker-build
      uses: ./.github/actions/docker-build-push
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        image-name: ${{ env.IMAGE_NAME }}
        push: true
        extra-tags: pr-${{ github.event.pull_request.number }}-${{ steps.short-sha.outputs.sha }}
  deploy-preview:
    name: deploy PR Preview
    runs-on: wsl
    needs: setup-preview
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Deploy PR Preview
      uses: ./.github/actions/helm-deploy
      with:
        release-name: ${{ needs.setup-preview.outputs.release-name }}
        namespace: ${{ needs.setup-preview.outputs.namespace }}
        environment: dev
        image-tag: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
        timeout: 5m
  
  comment-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: setup-preview
    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const namespace = '${{ needs.setup-preview.outputs.namespace }}';
          const url = `https://pr-${prNumber}.dev-book-library.example.com`;
          
          const comment = `## ðŸš€ Preview Deployment Ready!
          
          Your PR has been deployed to a preview environment:
          
          - **URL**: ${url}
          - **Namespace**: ${namespace}
          - **Image**: pr-${prNumber}-${context.sha.substring(0, 8)}
          
          The preview will be automatically cleaned up when the PR is closed.`;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

  cleanup-preview:
    name: Cleanup PR Preview
    runs-on: wsl
    needs: setup-preview
    if: github.event.action == 'closed'
    steps:
    - name: Delete preview deployment
      run: |
        helm uninstall ${{ needs.setup-preview.outputs.release-name }} -n ${{ needs.setup-preview.outputs.namespace }} || true
        kubectl delete namespace ${{ needs.setup-preview.outputs.namespace }} --wait=false || true
  
  post-cleanup-pr-comment:
    runs-on: ubuntu-latest
    needs: cleanup-preview
    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          
          const comment = `## ðŸ§¹ Preview Deployment Cleaned Up
          
          The preview deployment for PR #${prNumber} has been removed.`;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });